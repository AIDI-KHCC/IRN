{% extends 'users/base.html' %}
{% load static %}

{% block title %}Review Dashboard{% endblock %}

{% block page_specific_css %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.bootstrap4.min.css">
<style>
    .status-badge {
        padding: 0.4em 0.8em;
        border-radius: 0.25rem;
        font-size: 0.875em;
    }
    .status-pending { background-color: #ffc107; color: #000; }
    .status-accepted { background-color: #17a2b8; color: #fff; }
    .status-completed { background-color: #28a745; color: #fff; }
    .status-overdue { background-color: #dc3545; color: #fff; }
    
    .days-remaining {
        font-weight: bold;
    }
    .days-warning { color: #ffc107; }
    .days-danger { color: #dc3545; }
    .days-safe { color: #28a745; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h1 class="mb-4">Review Dashboard</h1>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <button class="btn btn-link" data-bs-toggle="collapse" data-bs-target="#filterCollapse">
                    <i class="fas fa-filter"></i> Filters
                </button>
            </h5>
        </div>
        <div id="filterCollapse" class="collapse show">
            <div class="card-body">
                <form id="filterForm" class="row g-3">
                    <div class="col-md-3">
                        <label for="status">Status</label>
                        <select id="status" class="form-select">
                            <option value="">All</option>
                            {% for status in status_choices %}
                            <option value="{{ status.0 }}">{{ status.1 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="study_type">Study Type</label>
                        <select id="study_type" class="form-select">
                            <option value="">All</option>
                            {% for type in study_types %}
                            <option value="{{ type.id }}">{{ type.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="date_from">From Date</label>
                        <input type="date" id="date_from" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label for="date_to">To Date</label>
                        <input type="date" id="date_to" class="form-control">
                    </div>
                    <div class="col-12">
                        <button type="button" id="applyFilters" class="btn btn-primary">Apply Filters</button>
                        <button type="button" id="resetFilters" class="btn btn-secondary">Reset</button>
                        <button type="button" id="exportPDF" class="btn btn-success float-end">
                            <i class="fas fa-file-pdf"></i> Export to PDF
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Pending Reviews Table -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Pending Reviews</h5>
        </div>
        <div class="card-body">
            <table id="pendingReviewsTable" class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Primary Investigator</th>
                        <th>Study Type</th>
                        <th>Deadline</th>
                        <th>Status</th>
                        <th>Days Remaining</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- DataTables will populate this -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Completed Reviews Table -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Completed Reviews</h5>
        </div>
        <div class="card-body">
            <table id="completedReviewsTable" class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Primary Investigator</th>
                        <th>Submitted On</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for review in completed_reviews %}
                    <tr>
                        <td>{{ review.submission.title }}</td>
                        <td>{{ review.submission.primary_investigator.userprofile.full_name }}</td>
                        <td>{{ review.date_submitted|date:"M d, Y" }}</td>
                        <td>
                            <a href="{% url 'review:view_review' review.id %}" class="btn btn-sm btn-info">
                                <i class="fas fa-eye"></i> View
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block page_specific_js %}
<script src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.bootstrap4.min.js"></script>
<script>
$(document).ready(function() {
    // Initialize DataTable
    var table = $('#pendingReviewsTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '{% url "review:review_dashboard" %}',
            data: function(d) {
                d.status = $('#status').val();
                d.study_type = $('#study_type').val();
                d.date_from = $('#date_from').val();
                d.date_to = $('#date_to').val();
            }
        },
        columns: [
            { data: 'title' },
            { data: 'investigator' },
            { data: 'study_type' },
            { data: 'deadline' },
            { 
                data: 'status',
                render: function(data, type, row) {
                    return '<span class="status-badge status-' + data.toLowerCase() + '">' + data + '</span>';
                }
            },
            { 
                data: 'days_remaining',
                render: function(data, type, row) {
                    let className = data <= 7 ? 'days-danger' : 
                                  data <= 14 ? 'days-warning' : 'days-safe';
                    return '<span class="days-remaining ' + className + '">' + data + '</span>';
                }
            },
            { 
                data: 'actions',
                orderable: false
            }
        ],
        order: [[3, 'asc']],
        pageLength: 10,
        dom: 'Bfrtip',
        buttons: [
            'copy', 'excel', 'csv'
        ]
    });

    // Initialize completed reviews table
    $('#completedReviewsTable').DataTable({
        pageLength: 10,
        order: [[2, 'desc']]
    });

    // Filter handling
    $('#applyFilters').click(function() {
        table.ajax.reload();
    });

    $('#resetFilters').click(function() {
        $('#filterForm')[0].reset();
        table.ajax.reload();
    });

    // PDF Export
    $('#exportPDF').click(function() {
        let params = new URLSearchParams({
            export: 'pdf',
            status: $('#status').val(),
            study_type: $('#study_type').val(),
            date_from: $('#date_from').val(),
            date_to: $('#date_to').val()
        });
        window.location.href = '{% url "review:review_dashboard" %}?' + params.toString();
    });
});
</script>
{% endblock %}