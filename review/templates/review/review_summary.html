{# review/templates/review/review_summary.html #}
{% extends 'users/base.html' %}
{% load static %}

{% block title %}Review Summary - {{ submission.title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header">
            <h2>Review Summary</h2>
            <h4>{{ submission.title }}</h4>
        </div>
        <div class="card-body">
            <!-- Submission Details -->
            <div class="alert alert-info">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Primary Investigator:</strong> 
                           {{ submission.primary_investigator.userprofile.full_name }}</p>
                        <p><strong>Study Type:</strong> 
                           {{ submission.study_type.name }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Version:</strong> {{ submission.version }}</p>
                        <p><strong>Status:</strong> 
                           <span class="badge bg-{{ submission.status|lower }}">
                               {{ submission.get_status_display }}
                           </span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Reviews List -->
            {% for review in reviews %}
            <div class="card mb-3">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Review by {{ review.reviewer.userprofile.full_name }}</h5>
                        <span class="text-muted">
                            Submitted {{ review.date_submitted|date:"F d, Y H:i" }}
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    {% for response in review.formresponse_set.all %}
                    <div class="mb-4">
                        <h6>{{ response.form.name }}</h6>
                        {% for field, value in response.response_data.items %}
                        <div class="mb-2">
                            <strong>{{ field }}:</strong>
                            <div class="ml-3">{{ value }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}

                    {% if review.comments %}
                    <div class="mt-3">
                        <h6>Additional Comments</h6>
                        <div class="border-left pl-3">
                            {{ review.comments|linebreaks }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="alert alert-warning">
                No reviews submitted yet.
            </div>
            {% endfor %}

            <!-- IRB Coordinator Actions -->
            {% if can_make_decision and submission.status == 'reviews_completed' %}
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">Make IRB Decision</h5>
                </div>
                <div class="card-body">
                    <form method="post" action="{% url 'review:process_decision' submission.id %}">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label class="form-label">Decision</label>
                            <select name="decision" class="form-select" required>
                                <option value="">Select decision...</option>
                                <option value="approved">Approve</option>
                                <option value="revision_required">Request Revision</option>
                                <option value="rejected">Reject</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Comments</label>
                            <textarea name="comments" class="form-control" rows="4" required></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            Submit Decision
                        </button>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{# review/templates/review/process_decision.html #}
{% extends 'users/base.html' %}
{% load crispy_forms_tags %}

{% block title %}Process IRB Decision{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header">
                    <h2>Process IRB Decision</h2>
                    <h5>{{ submission.title }}</h5>
                </div>
                <div class="card-body">
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label class="form-label required">Decision</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="decision" 
                                       value="approved" id="decision_approved" required>
                                <label class="form-check-label" for="decision_approved">
                                    Approve
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="decision"
                                       value="revision_required" id="decision_revision" required>
                                <label class="form-check-label" for="decision_revision">
                                    Request Revision
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="decision"
                                       value="rejected" id="decision_rejected" required>
                                <label class="form-check-label" for="decision_rejected">
                                    Reject
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="comments" class="form-label required">Comments</label>
                            <textarea class="form-control" id="comments" name="comments"
                                    rows="5" required></textarea>
                            <div class="invalid-feedback">
                                Please provide comments explaining your decision.
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'review:review_summary' submission.id %}" 
                               class="btn btn-secondary me-md-2">Cancel</a>
                            <button type="submit" class="btn btn-primary">Submit Decision</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_specific_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Form validation
        const form = document.querySelector('form');
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        });

        // Dynamic requirements based on decision
        const decisionInputs = document.querySelectorAll('input[name="decision"]');
        const commentsField = document.getElementById('comments');
        
        decisionInputs.forEach(input => {
            input.addEventListener('change', function() {
                if (this.value === 'revision_required' || this.value === 'rejected') {
                    commentsField.setAttribute('required', '');
                } else {
                    commentsField.removeAttribute('required');
                }
            });
        });
    });
</script>
{% endblock %}