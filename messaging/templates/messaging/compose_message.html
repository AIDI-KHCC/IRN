{% extends 'users/base.html' %}
{% load crispy_forms_tags %}

{% block title %}Compose Message{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header">
                    <h2>
                        {% if is_reply %}Reply
                        {% elif is_reply_all %}Reply All
                        {% elif is_forward %}Forward
                        {% else %}Compose Message
                        {% endif %}
                    </h2>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" novalidate>
                        {% csrf_token %}
                        
                        {# Subject Field #}
                        {{ form.subject|as_crispy_field }}

                        {# Related Study Field #}
                        {{ form.related_submission|as_crispy_field }}
                        <small class="text-muted d-block mt-1 mb-3">Search by study title or IRB number</small>

                        {# Recipients Fields #}
                        {{ form.recipients|as_crispy_field }}
                        {{ form.cc|as_crispy_field }}
                        {{ form.bcc|as_crispy_field }}

                        {# Message Body #}
                        {{ form.body|as_crispy_field }}

                        {# Attachments #}
                        {{ form.attachment|as_crispy_field }}
                        <small class="text-muted d-block mt-1 mb-3">Select a file to attach</small>

                        {# Submit Buttons #}
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a href="{% url 'messaging:inbox' %}" class="btn btn-secondary me-md-2">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">Send</button>
                            <a href="{% url 'messaging:inbox' %}" class="btn btn-secondary">Cancel</a>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_specific_js %}
<script>
    $(document).ready(function() {
        // Initialize Select2 for recipients, cc, and bcc fields
        $('#id_recipients, #id_cc, #id_bcc').select2({
            theme: 'bootstrap4',
            ajax: {
                url: '{% url "messaging:user_autocomplete" %}',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        term: params.term,
                        page: params.page
                    };
                },
                processResults: function (data) {
                    return {
                        results: data.map(function(item) {
                            return {
                                id: item.id,
                                text: item.label
                            };
                        })
                    };
                },
                cache: true
            },
            minimumInputLength: 2,
            placeholder: 'Search for users...',
            allowClear: true,
            multiple: true,
            width: '100%'
        });

        // Initialize Select2 for related submission field
        $('#id_related_submission').select2({
            theme: 'bootstrap4',
            ajax: {
                url: '{% url "messaging:submission_autocomplete" %}',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        term: params.term,
                        page: params.page
                    };
                },
                processResults: function (data) {
                    return data;
                },
                cache: true
            },
            minimumInputLength: 2,
            placeholder: 'Search for a study...',
            allowClear: true,
            multiple: false,
            width: '100%'
        });

        // Handle initial values if they exist
        {% if form.recipients.initial %}
            var initialRecipients = {{ form.recipients.initial|safe }};
            initialRecipients.forEach(function(user) {
                var option = new Option(user.text, user.id, true, true);
                $('#id_recipients').append(option);
            });
            $('#id_recipients').trigger('change');
        {% endif %}

        {% if form.related_submission.initial %}
            var initialSubmission = {
                id: '{{ form.related_submission.initial.id }}',
                text: '{{ form.related_submission.initial.title|escapejs }}'
            };
            var initialOption = new Option(initialSubmission.text, initialSubmission.id, true, true);
            $('#id_related_submission').append(initialOption).trigger('change');
        {% endif %}

        // Optional: Show selected file name
        $('#id_attachment').on('change', function() {
            var fileName = $(this).val().split('\\').pop();
            $(this).next('.text-muted').text(fileName || 'Select a file to attach');
        });
    });
</script>
{% endblock %}
