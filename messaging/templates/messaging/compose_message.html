{% extends 'users/base.html' %}
{% load i18n %}
{% load crispy_forms_tags %}

{% block extra_head %}
    <!-- Add Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        .select2-container {
            width: 100% !important;
            margin-bottom: 10px;
        }
        
        .select2-selection--single {
            height: 38px !important;
            padding: 5px !important;
            border: 1px solid #ced4da !important;
            border-radius: 4px !important;
        }
        
        .select2-selection__rendered {
            line-height: 26px !important;
            padding-left: 8px !important;
        }
        
        .select2-selection__arrow {
            height: 36px !important;
        }
        
        .select2-selection--multiple {
            border: 1px solid #ced4da !important;
            min-height: 38px !important;
        }
        
        .select2-search__field {
            margin-top: 5px !important;
        }
        
        .select2-container .select2-selection--single .select2-selection__clear {
            margin-right: 25px;
            color: #999;
            font-size: 18px;
        }
        
        .form-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #495057;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>
        {% if is_reply %}Reply{% elif is_reply_all %}Reply All{% elif is_forward %}Forward{% else %}Compose Message{% endif %}
    </h2>
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <!-- Subject Field -->
        <div class="mb-3">
            <label for="id_subject" class="form-label">Subject</label>
            {{ form.subject }}
        </div>

        <!-- Related Submission Field -->
        <div class="mb-4">
            <label for="id_related_submission" class="form-label">Related Study</label>
            {{ form.related_submission }}
            <small class="text-muted d-block mt-1">Search by study title or IRB number</small>
        </div>

        <!-- Recipients Fields -->
        <div class="mb-3">
            <label for="id_recipients" class="form-label">To</label>
            {{ form.recipients }}
        </div>
        <div class="mb-3">
            <label for="id_cc" class="form-label">CC</label>
            {{ form.cc }}
        </div>
        <div class="mb-3">
            <label for="id_bcc" class="form-label">BCC</label>
            {{ form.bcc }}
        </div>

        <!-- Message Body -->
        <div class="mb-3">
            <label for="id_body" class="form-label">Message</label>
            {{ form.body }}
        </div>

        <!-- Attachments -->
        <div class="mb-3">
            <label for="id_attachment" class="form-label">Attachment</label>
            {{ form.attachment }}
            <small class="text-muted">Select a file to attach</small>
        </div>

        <!-- Submit Buttons -->
        <div class="mt-4">
            <button type="submit" class="btn btn-primary">Send</button>
            <a href="{% url 'messaging:inbox' %}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
    <!-- Add Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function() {
            // Initialize Select2 for recipients, cc, and bcc fields
            $('#id_recipients, #id_cc, #id_bcc').select2({
                theme: 'bootstrap4',
                ajax: {
                    url: '{% url "messaging:user_autocomplete" %}',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            term: params.term,
                            page: params.page
                        };
                    },
                    processResults: function (data) {
                        return {
                            results: data.map(function(item) {
                                return {
                                    id: item.id,
                                    text: item.label
                                };
                            })
                        };
                    },
                    cache: true
                },
                minimumInputLength: 2,
                placeholder: 'Search for users...',
                allowClear: true,
                multiple: true
            });

            // Initialize Select2 for submission field
            $('#id_related_submission').select2({
                theme: 'bootstrap4',
                ajax: {
                    url: '{% url "messaging:submission_autocomplete" %}',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            term: params.term,
                            page: params.page
                        };
                    },
                    processResults: function (data) {
                        return data;
                    },
                    cache: true
                },
                minimumInputLength: 2,
                placeholder: 'Search for a study...',
                allowClear: true,
                multiple: false,
                width: '100%',
                dropdownParent: $('#id_related_submission').parent()
            });

            // Optional: Show selected file name
            $('#id_attachment').on('change', function() {
                var fileName = $(this).val().split('\\').pop();
                $(this).next('.text-muted').text(fileName || 'Select a file to attach');
            });
        });
    </script>
{% endblock %}
